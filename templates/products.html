{% extends "base.html" %}

{% block title %}Products - Electrical Shop Management{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="bi bi-box"></i> Product Management</h1>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">
                <i class="bi bi-plus-circle"></i> Add Product
            </button>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0">All Products</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="productsTable">
                        <thead class="table-dark">
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Unit Price</th>
                                <th>Quantity</th>
                                <th>Min Stock</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsBody">
                            <tr><td colspan="8" class="text-center text-muted">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div class="modal fade" id="addProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Add New Product</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addProductForm">
                    <div class="mb-3">
                        <label class="form-label">Product Name *</label>
                        <input type="text" class="form-control" id="productName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category *</label>
                        <input type="text" class="form-control" id="productCategory" placeholder="e.g., Bulbs, Switches" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Unit Price (₹) *</label>
                        <input type="number" class="form-control" id="productPrice" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Initial Quantity</label>
                        <input type="number" class="form-control" id="productQuantity" value="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Minimum Stock Level</label>
                        <input type="number" class="form-control" id="productMinStock" value="5">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addProduct()">Add Product</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Product Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">Edit Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editProductForm">
                    <input type="hidden" id="editProductId">
                    <div class="mb-3">
                        <label class="form-label">Product Name</label>
                        <input type="text" class="form-control" id="editProductName">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <input type="text" class="form-control" id="editProductCategory">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Unit Price (₹)</label>
                        <input type="number" class="form-control" id="editProductPrice" step="0.01">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Minimum Stock</label>
                        <input type="number" class="form-control" id="editProductMinStock">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="updateProduct()">Update</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Load products
    function loadProducts() {
        fetch('/api/products')
            .then(response => response.json())
            .then(data => {
                const tbody = document.getElementById('productsBody');
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No products found</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(product => `
                    <tr>
                        <td>${product.id}</td>
                        <td><strong>${product.name}</strong></td>
                        <td>${product.category}</td>
                        <td>₹${product.unit_price.toFixed(2)}</td>
                        <td>${product.quantity}</td>
                        <td>${product.minimum_stock}</td>
                        <td>
                            <span class="badge bg-${product.status === 'LOW' ? 'warning' : 'success'}">
                                ${product.status}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editProduct(${product.id})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteProduct(${product.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            });
    }

    function addProduct() {
        const formData = {
            name: document.getElementById('productName').value,
            category: document.getElementById('productCategory').value,
            unit_price: document.getElementById('productPrice').value,
            quantity: document.getElementById('productQuantity').value || 0,
            minimum_stock: document.getElementById('productMinStock').value || 5
        };

        fetch('/api/products', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Product added successfully!');
                document.getElementById('addProductForm').reset();
                bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
                loadProducts();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }

    function editProduct(id) {
        const product = fetch(`/api/products`).then(r => r.json()).then(products => {
            const p = products.find(x => x.id === id);
            if (p) {
                document.getElementById('editProductId').value = p.id;
                document.getElementById('editProductName').value = p.name;
                document.getElementById('editProductCategory').value = p.category;
                document.getElementById('editProductPrice').value = p.unit_price;
                document.getElementById('editProductMinStock').value = p.minimum_stock;
                new bootstrap.Modal(document.getElementById('editProductModal')).show();
            }
        });
    }

    function updateProduct() {
        const id = document.getElementById('editProductId').value;
        const formData = {
            name: document.getElementById('editProductName').value,
            category: document.getElementById('editProductCategory').value,
            unit_price: document.getElementById('editProductPrice').value,
            minimum_stock: document.getElementById('editProductMinStock').value
        };

        fetch(`/api/products/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Product updated successfully!');
                bootstrap.Modal.getInstance(document.getElementById('editProductModal')).hide();
                loadProducts();
            }
        });
    }

    function deleteProduct(id) {
        if (confirm('Are you sure you want to delete this product?')) {
            fetch(`/api/products/${id}`, {method: 'DELETE'})
                .then(response => response.json())
                .then(data => {
                    alert('Product deleted successfully!');
                    loadProducts();
                });
        }
    }

    // Load on page load
    loadProducts();
</script>
{% endblock %}
