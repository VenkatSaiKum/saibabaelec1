{% extends "base.html" %}

{% block title %}Expenses - Electrical Shop Management{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1 class="mb-4"><i class="bi bi-cash-coin"></i> Daily Expenses Management</h1>
    </div>
</div>

<ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#addExpense">Add Expense</a>
    </li>
    <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#expenseHistory">Today's Expenses</a>
    </li>
</ul>

<div class="tab-content">
    <!-- Add Expense Tab -->
    <div id="addExpense" class="tab-pane fade show active">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="bi bi-plus-circle"></i> Record New Expense</h5>
                    </div>
                    <div class="card-body">
                        <form id="addExpenseForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Category *</label>
                                    <select class="form-select" id="expenseCategory" required>
                                        <option value="">Select Category...</option>
                                        <option value="Salary">Salary</option>
                                        <option value="Rent">Rent/Space</option>
                                        <option value="Electricity">Electricity Bill</option>
                                        <option value="Internet">Internet/Telecom</option>
                                        <option value="Supplies">Office Supplies</option>
                                        <option value="Maintenance">Maintenance/Repair</option>
                                        <option value="Transport">Transport/Fuel</option>
                                        <option value="Food">Food/Beverages</option>
                                        <option value="Insurance">Insurance</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Amount (₹) *</label>
                                    <input type="number" class="form-control" id="expenseAmount" step="0.01" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Description *</label>
                                <input type="text" class="form-control" id="expenseDescription" placeholder="What is this expense for?" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-control" id="expenseDate">
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-outline-secondary w-100" onclick="clearExpenseForm()">
                                        Clear
                                    </button>
                                </div>
                                <div class="col-md-6">
                                    <button type="button" class="btn btn-danger w-100" onclick="submitExpense()">
                                        <i class="bi bi-check-circle"></i> Add Expense
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">Quick Info</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <h6 class="text-muted">Today's Total Expenses</h6>
                            <h2 class="text-danger" id="todayTotal">₹0.00</h2>
                        </div>

                        <div class="mb-4">
                            <h6 class="text-muted">Expense Categories</h6>
                            <small id="expenseCategoriesInfo" class="text-muted">Select a date to view</small>
                        </div>

                        <hr>

                        <button type="button" class="btn btn-info btn-sm w-100" onclick="setTodayDate()">
                            <i class="bi bi-calendar-day"></i> Set Today
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Expense History Tab -->
    <div id="expenseHistory" class="tab-pane fade">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <div class="row align-items-center">
                    <div class="col-md-9">
                        <h5 class="mb-0">Daily Expenses List</h5>
                    </div>
                    <div class="col-md-3">
                        <input type="date" class="form-control form-control-sm" id="filterDate" onchange="loadDailyExpenses()">
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="expensesTable">
                        <thead class="table-light">
                            <tr>
                                <th>Category</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Date</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="expensesBody">
                            <tr><td colspan="5" class="text-center text-muted">Loading...</td></tr>
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <th colspan="2" class="text-end">Total:</th>
                                <th id="expensesTotal">₹0.00</th>
                                <th colspan="2"></th>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="row mt-4">
                    <div class="col-md-12">
                        <h6 class="text-muted mb-3">Category Breakdown</h6>
                        <div id="categoryBreakdown">
                            <p class="text-muted">Select a date to view breakdown</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Set today's date as default
    function setTodayDate() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('expenseDate').value = today;
        document.getElementById('filterDate').value = today;
        loadDailyExpenses();
    }

    function loadDailyExpenses() {
        const date = document.getElementById('filterDate').value;
        if (!date) return;

        fetch(`/api/expenses?date=${date}`)
            .then(r => r.json())
            .then(expenses => {
                const tbody = document.getElementById('expensesBody');
                if (expenses.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No expenses for this date</td></tr>';
                } else {
                    let total = 0;
                    tbody.innerHTML = expenses.map(exp => {
                        total += exp.amount;
                        return `
                            <tr>
                                <td><span class="badge bg-warning text-dark">${exp.category}</span></td>
                                <td>${exp.description}</td>
                                <td>₹${exp.amount.toFixed(2)}</td>
                                <td>${exp.expense_date}</td>
                                <td>
                                    <button class="btn btn-sm btn-danger" onclick="deleteExpense(${exp.id})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    document.getElementById('expensesTotal').textContent = '₹' + total.toFixed(2);
                }
                loadExpenseSummary(date);
            });
    }

    function loadExpenseSummary(date) {
        fetch(`/api/expenses/daily-summary?date=${date}`)
            .then(r => r.json())
            .then(data => {
                document.getElementById('todayTotal').textContent = '₹' + data.total.toFixed(2);
                
                if (data.summary.length > 0) {
                    let html = '<div class="list-group">';
                    data.summary.forEach(cat => {
                        html += `
                            <div class="list-group-item d-flex justify-content-between">
                                <div>
                                    <span class="badge bg-info text-dark">${cat.category}</span>
                                    <small class="ms-2 text-muted">x${cat.count}</small>
                                </div>
                                <strong>₹${cat.total.toFixed(2)}</strong>
                            </div>
                        `;
                    });
                    html += '</div>';
                    document.getElementById('categoryBreakdown').innerHTML = html;
                }
            });
    }

    function submitExpense() {
        const category = document.getElementById('expenseCategory').value;
        const amount = document.getElementById('expenseAmount').value;
        const description = document.getElementById('expenseDescription').value;
        const date = document.getElementById('expenseDate').value || new Date().toISOString().split('T')[0];

        if (!category || !amount || !description) {
            alert('Please fill all required fields');
            return;
        }

        fetch('/api/expenses', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                category, amount, description, expense_date: date
            })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('Expense added successfully!');
                clearExpenseForm();
                document.getElementById('filterDate').value = date;
                loadDailyExpenses();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }

    function deleteExpense(id) {
        if (confirm('Are you sure you want to delete this expense?')) {
            fetch(`/api/expenses/${id}`, {method: 'DELETE'})
                .then(r => r.json())
                .then(data => {
                    alert('Expense deleted!');
                    const date = document.getElementById('filterDate').value;
                    loadDailyExpenses();
                });
        }
    }

    function clearExpenseForm() {
        document.getElementById('addExpenseForm').reset();
    }

    // Initialize on load
    setTodayDate();
</script>
{% endblock %}
